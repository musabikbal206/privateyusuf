<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Campus Detective | Describing People</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Playfair+Display:wght@700&display=swap');

        :root {
            --navy: #0A192F;
            --navy-light: #112240;
            --gold: #D4AF37;
            --cream: #F8F8F0;
            --success: #2ecc71;
            --error: #e74c3c;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--navy);
            color: var(--cream);
            font-family: 'Lato', sans-serif;
            overflow: hidden;
            touch-action: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            user-select: none;
        }

        #game-wrapper {
            position: relative;
            width: 100%;
            max-width: 800px;
            height: 500px;
            background: linear-gradient(135deg, var(--navy-light) 0%, #1e3a5f 100%);
            border: 4px solid var(--gold);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        /* HUD */
        #hud {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 15px;
            background: rgba(10, 25, 47, 0.9);
            border-bottom: 2px solid var(--gold);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 10;
        }

        #task-text {
            font-family: 'Playfair Display', serif;
            font-size: 1.4rem;
            color: var(--gold);
            text-align: center;
            margin-bottom: 5px;
        }

        #score-display {
            font-size: 1rem;
            color: var(--cream);
            opacity: 0.8;
        }

        /* OVERLAYS */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 25, 47, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            z-index: 20;
            padding: 20px;
            transition: opacity 0.3s;
        }

        h1 {
            font-family: 'Playfair Display', serif;
            color: var(--gold);
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px var(--navy);
        }

        p {
            font-size: 1.2rem;
            line-height: 1.6;
            max-width: 600px;
            margin-bottom: 25px;
            color: #d1d5db;
        }

        .btn {
            background: var(--gold);
            color: var(--navy);
            border: none;
            padding: 12px 30px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            box-shadow: 0 4px 0 #b08d28;
            font-family: 'Playfair Display', serif;
        }

        .btn:active { transform: translateY(4px); box-shadow: none; }
        .btn:hover { background: #fff; }

        /* FEEDBACK POPUP */
        #feedback-popup {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--navy);
            border: 2px solid var(--gold);
            padding: 20px 40px;
            border-radius: 10px;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--cream);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 15;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

    </style>
</head>
<body>

    <div id="game-wrapper">
        <canvas id="gameCanvas"></canvas>

        <div id="hud">
            <div id="task-text">Loading...</div>
            <div id="score-display">Score: 0 | Level: 1</div>
        </div>

        <div id="feedback-popup">Correct!</div>

        <!-- START SCREEN -->
        <div id="start-screen" class="overlay">
            <h1>Campus Detective</h1>
            <p>Yusuf needs to find his friends in the busy crowd!</p>
            <p>Read the description at the top and <b>click on the correct person</b>.</p>
            <button class="btn" onclick="startGame()">Start Search</button>
        </div>

        <!-- GAME OVER SCREEN -->
        <div id="game-over-screen" class="overlay" style="display: none;">
            <h1 id="go-title">Great Job!</h1>
            <p id="go-msg">You found everyone.</p>
            <p>Final Score: <span id="final-score" style="color:var(--gold); font-weight:bold;">0</span></p>
            <button class="btn" onclick="startGame()">Play Again</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let width, height;
        function resize() {
            width = canvas.width = document.getElementById('game-wrapper').offsetWidth;
            height = canvas.height = document.getElementById('game-wrapper').offsetHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        /* --- GAME STATE --- */
        let score = 0;
        let level = 1;
        let faces = [];
        let targetFace = null;
        let isPlaying = false;
        
        // Defined Characters from Story
        const storyCharacters = [
            {
                name: "Selin",
                desc: "Find Selin: Curly Brown Hair and Green Eyes.",
                traits: { hairColor: '#8B4513', hairStyle: 'curly', eyeColor: '#2ecc71', glasses: false, bald: false, age: 'young', freckles: false }
            },
            {
                name: "Arda",
                desc: "Find Arda: Red Hair and Freckles.",
                traits: { hairColor: '#e74c3c', hairStyle: 'straight', eyeColor: '#34495e', glasses: false, bald: false, age: 'young', freckles: true }
            },
            {
                name: "Prof. Orhan",
                desc: "Find Professor Orhan: Bald and Glasses.",
                traits: { hairColor: '#333', hairStyle: 'bald', eyeColor: '#333', glasses: true, bald: true, age: 'old', freckles: false }
            },
            {
                name: "Azra",
                desc: "Find Azra: Short Grey Hair and Blue Eyes.",
                traits: { hairColor: '#95a5a6', hairStyle: 'short', eyeColor: '#3498db', glasses: false, bald: false, age: 'old', freckles: false }
            }
        ];

        /* --- GENERATOR --- */
        function generateRandomFace(x, y) {
            const hairColors = ['#8B4513', '#e74c3c', '#f1c40f', '#2c3e50', '#95a5a6']; // Brown, Red, Blonde, Black, Grey
            const hairStyles = ['curly', 'straight', 'short', 'bald'];
            const eyeColors = ['#2ecc71', '#3498db', '#5d4037']; // Green, Blue, Brown
            
            return {
                x: x, y: y, size: 45,
                traits: {
                    hairColor: hairColors[Math.floor(Math.random() * hairColors.length)],
                    hairStyle: hairStyles[Math.floor(Math.random() * hairStyles.length)],
                    eyeColor: eyeColors[Math.floor(Math.random() * eyeColors.length)],
                    glasses: Math.random() > 0.8,
                    bald: Math.random() > 0.9, 
                    age: Math.random() > 0.7 ? 'old' : 'young',
                    freckles: Math.random() > 0.8
                }
            };
        }

        /* --- DRAWING --- */
        function drawFace(face) {
            const { x, y, size, traits } = face;
            const skinColor = "#f1c27d"; 

            ctx.save();
            ctx.translate(x, y);

            // Head
            ctx.fillStyle = skinColor;
            ctx.beginPath();
            ctx.arc(0, 0, size, 0, Math.PI * 2);
            ctx.fill();

            // Wrinkles (if old)
            if (traits.age === 'old') {
                ctx.strokeStyle = "#d35400";
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(-15, -10); ctx.lineTo(15, -10); // Forehead
                ctx.moveTo(-20, 10); ctx.lineTo(-10, 20); // Cheeks
                ctx.moveTo(20, 10); ctx.lineTo(10, 20);
                ctx.stroke();
            }

            // Eyes
            ctx.fillStyle = "#fff";
            ctx.beginPath();
            ctx.ellipse(-12, -5, 8, 5, 0, 0, Math.PI * 2);
            ctx.ellipse(12, -5, 8, 5, 0, 0, Math.PI * 2);
            ctx.fill();

            // Iris
            ctx.fillStyle = traits.eyeColor;
            ctx.beginPath();
            ctx.arc(-12, -5, 3, 0, Math.PI * 2);
            ctx.arc(12, -5, 3, 0, Math.PI * 2);
            ctx.fill();

            // Glasses
            if (traits.glasses) {
                ctx.strokeStyle = "#333";
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(-12, -5, 10, 0, Math.PI * 2);
                ctx.arc(12, -5, 10, 0, Math.PI * 2);
                ctx.moveTo(-2, -5); ctx.lineTo(2, -5); // Bridge
                ctx.stroke();
            }

            // Freckles
            if (traits.freckles) {
                ctx.fillStyle = "#a1887f";
                for(let i=0; i<3; i++) {
                    ctx.beginPath(); ctx.arc(-15 + i*4, 10, 1, 0, Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.arc(7 + i*4, 10, 1, 0, Math.PI*2); ctx.fill();
                }
            }

            // Mouth (Simple Smile)
            ctx.strokeStyle = "#c0392b";
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(0, 15, 10, 0, Math.PI, false);
            ctx.stroke();

            // Hair Logic - UPDATED TO NOT COVER FACE
            if (!traits.bald && traits.hairStyle !== 'bald') {
                ctx.fillStyle = traits.hairColor;
                ctx.beginPath();
                if (traits.hairStyle === 'curly') {
                    // Curly poofs - moved higher and wider
                    for(let i=0; i<8; i++) ctx.arc(-35 + i*10, -38, 14, 0, Math.PI*2); // Higher top (-38)
                    for(let i=0; i<3; i++) ctx.arc(-44, -15 + i*10, 12, 0, Math.PI*2); // Wider Left (-44)
                    for(let i=0; i<3; i++) ctx.arc(44, -15 + i*10, 12, 0, Math.PI*2); // Wider Right (44)
                } else if (traits.hairStyle === 'straight') {
                    // Straight block - Higher Bangs
                    ctx.moveTo(-35, -5); 
                    ctx.lineTo(-35, -45); 
                    ctx.quadraticCurveTo(0, -65, 35, -45); 
                    ctx.lineTo(35, -5); 
                    ctx.lineTo(35, -35); 
                    ctx.lineTo(-35, -35); // Bangs line raised to -35 (above eyes)
                } else if (traits.hairStyle === 'short') {
                    // Spiky/Short - Moved up
                    ctx.arc(0, -20, 38, Math.PI, 0); // Center raised to -20
                }
                ctx.fill();
            } else {
                // Bald shine
                 ctx.fillStyle = "rgba(255,255,255,0.4)";
                 ctx.beginPath();
                 ctx.ellipse(-10, -30, 5, 2, Math.PI/4, 0, Math.PI*2);
                 ctx.fill();
            }

            ctx.restore();
        }

        /* --- LOGIC --- */

        function startGame() {
            score = 0;
            level = 0;
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('game-over-screen').style.display = 'none';
            isPlaying = true;
            nextLevel();
        }

        function nextLevel() {
            if (level >= storyCharacters.length) {
                // Could implement endless random mode here
                gameOver(true);
                return;
            }

            // Setup Target
            const storyData = storyCharacters[level];
            document.getElementById('task-text').textContent = storyData.desc;
            document.getElementById('score-display').textContent = `Score: ${score} | Level: ${level + 1}`;

            // Create Faces
            faces = [];
            
            // 1. Add Target Face
            const padding = 60;
            let tx = padding + Math.random() * (width - padding*2);
            let ty = padding + Math.random() * (height - padding*2);
            
            targetFace = {
                x: tx, y: ty, size: 45,
                traits: storyData.traits,
                isTarget: true
            };
            faces.push(targetFace);

            // 2. Add Distractors (Increased Count)
            const distractorCount = 15 + level * 8; // Start with ~23, add 8 per level
            for (let i=0; i<distractorCount; i++) {
                let safe = false;
                let dx, dy;
                let attempts = 0;
                while(!safe && attempts < 100) {
                    dx = padding + Math.random() * (width - padding*2);
                    dy = padding + Math.random() * (height - padding*2);
                    // Collision check
                    safe = true;
                    for(let f of faces) {
                        // Reduced distance check to 70 to allow tighter crowds (depth)
                        if (Math.hypot(f.x - dx, f.y - dy) < 70) safe = false;
                    }
                    attempts++;
                }
                if(safe) {
                    let dFace = generateRandomFace(dx, dy);
                    faces.push(dFace);
                }
            }

            // Sort faces by Y coordinate for proper depth (lower Y drawn first)
            // Actually, higher Y (bottom of screen) should be drawn LAST (on top)
            faces.sort((a, b) => a.y - b.y);

            drawScene();
        }

        function drawScene() {
            // Background
            ctx.fillStyle = "#1e3a5f"; // Campus Floor
            ctx.fillRect(0, 0, width, height);
            
            // Draw grid lines
            ctx.strokeStyle = "rgba(255,255,255,0.05)";
            ctx.lineWidth = 2;
            ctx.beginPath();
            for(let i=0; i<width; i+=50) { ctx.moveTo(i,0); ctx.lineTo(i,height); }
            for(let i=0; i<height; i+=50) { ctx.moveTo(0,i); ctx.lineTo(width,i); }
            ctx.stroke();

            // Draw Faces (Sorted)
            faces.forEach(f => drawFace(f));
        }

        /* --- INTERACTION --- */
        canvas.addEventListener('click', handleInput);
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent("click", {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }, {passive: false});

        function handleInput(e) {
            if(!isPlaying) return;

            const rect = canvas.getBoundingClientRect();
            const cx = e.clientX - rect.left;
            const cy = e.clientY - rect.top;

            let clickedFace = null;
            // Check clicks (reverse order to hit top elements first)
            for(let i=faces.length-1; i>=0; i--) {
                const f = faces[i];
                if (Math.hypot(f.x - cx, f.y - cy) < f.size) {
                    clickedFace = f;
                    break;
                }
            }

            if (clickedFace) {
                if (clickedFace.isTarget) {
                    showFeedback("Correct!", "#2ecc71");
                    score += 100;
                    level++;
                    setTimeout(nextLevel, 1000);
                } else {
                    showFeedback("Wrong Person!", "#e74c3c");
                    score -= 20;
                    document.getElementById('score-display').textContent = `Score: ${score} | Level: ${level + 1}`;
                }
            }
        }

        function showFeedback(text, color) {
            const popup = document.getElementById('feedback-popup');
            popup.textContent = text;
            popup.style.borderColor = color;
            popup.style.opacity = 1;
            setTimeout(() => { popup.style.opacity = 0; }, 800);
        }

        function gameOver(win) {
            isPlaying = false;
            document.getElementById('game-over-screen').style.display = 'flex';
            document.getElementById('go-title').textContent = win ? "Mission Complete!" : "Game Over";
            document.getElementById('go-msg').textContent = win ? "You found all the students." : "Try again!";
            document.getElementById('final-score').textContent = score;
        }

        // Init
        drawScene();

    </script>
</body>
</html>
