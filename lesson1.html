<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Lesson | Meeting New People</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:wght@400;600;700&display=swap');

        :root {
            --navy: #0A192F;
            --navy-light: #112240;
            --gold: #D4AF37;
            --cream: #F8F8F0;
            --white: #ffffff;
            --success: #2ecc71;
            --error: #e74c3c;
            --shadow: 0 10px 30px -10px rgba(0,0,0,0.5);
            --accent: #64ffda; /* New accent for variety */
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--navy);
            color: var(--cream);
            font-family: 'Lato', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* HEADER */
        header {
            background: linear-gradient(180deg, var(--navy-light) 0%, var(--navy) 100%);
            padding: 2rem;
            text-align: center;
            border-bottom: 3px solid var(--gold);
            box-shadow: var(--shadow);
        }

        h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            color: var(--gold);
            margin-bottom: 0.5rem;
            letter-spacing: 1px;
        }

        .subtitle {
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 3px;
            opacity: 0.8;
        }

        /* CONTAINER */
        .container {
            max-width: 1000px;
            margin: 2rem auto;
            width: 95%;
            flex: 1;
        }

        /* NAVIGATION */
        .tabs {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 2rem;
        }

        .tab-btn {
            background: transparent;
            border: 1px solid var(--gold);
            color: var(--gold);
            padding: 10px 20px;
            font-family: 'Playfair Display', serif;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 4px;
            flex: 1 1 auto;
            text-align: center;
            min-width: 120px;
        }

        .tab-btn:hover, .tab-btn.active {
            background: var(--gold);
            color: var(--navy);
            transform: translateY(-2px);
            font-weight: bold;
        }

        /* SECTIONS */
        .section {
            display: none;
            animation: fadeIn 0.5s ease;
            background: var(--navy-light);
            padding: 2rem;
            border-radius: 12px;
            border: 1px solid rgba(212, 175, 55, 0.2);
            margin-bottom: 2rem;
        }

        .section.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h2 {
            font-family: 'Playfair Display', serif;
            color: var(--gold);
            border-bottom: 1px solid rgba(212, 175, 55, 0.3);
            padding-bottom: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ACTIVITY 1: STORY */
        .story-text {
            line-height: 1.8;
            font-size: 1.1rem;
        }

        .story-sentence {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .story-sentence:hover {
            background: rgba(212, 175, 55, 0.2);
        }

        .story-sentence.playing {
            background: var(--gold);
            color: var(--navy);
        }

        /* ACTIVITY 2: FLASHCARDS */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .card {
            background: var(--cream);
            color: var(--navy);
            height: 200px;
            perspective: 1000px;
            cursor: pointer;
            border-radius: 8px;
        }

        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }

        .card.flipped .card-inner {
            transform: rotateY(180deg);
        }

        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid var(--gold);
        }

        .card-back {
            transform: rotateY(180deg);
            background: var(--navy);
            color: var(--gold);
        }

        .card-icon { font-size: 3rem; margin-bottom: 10px; }
        .card-word { font-family: 'Playfair Display', serif; font-size: 1.4rem; font-weight: bold; }
        .card-def { font-size: 0.9rem; line-height: 1.4; }

        /* ACTIVITY 3: TRUE OR FALSE */
        .tf-container { display: flex; flex-direction: column; gap: 15px; }
        .tf-item {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .tf-btn {
            padding: 8px 16px;
            border: 1px solid var(--gold);
            background: transparent;
            color: var(--gold);
            cursor: pointer;
            margin-left: 5px;
            border-radius: 4px;
        }
        .tf-btn.correct { background: var(--success); color: white; border-color: var(--success); }
        .tf-btn.wrong { background: var(--error); color: white; border-color: var(--error); }

        /* ACTIVITY 4: SENTENCE BUILDER */
        .scramble-box {
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        .word-bank {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
            min-height: 50px;
        }
        .drop-zone {
            border-bottom: 2px solid var(--gold);
            min-height: 50px;
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            padding: 10px;
            margin-bottom: 15px;
            background: rgba(255,255,255,0.05);
        }
        .scramble-word {
            background: var(--cream);
            color: var(--navy);
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            user-select: none;
        }

        /* ACTIVITY 5: MATCH UP */
        .match-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .match-col { display: flex; flex-direction: column; gap: 10px; }
        .match-card {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border: 1px solid var(--gold);
            cursor: pointer;
            text-align: center;
            transition: 0.2s;
            border-radius: 6px;
        }
        .match-card:hover { background: rgba(212, 175, 55, 0.2); }
        .match-card.selected { background: var(--gold); color: var(--navy); }
        .match-card.matched { background: var(--success); color: white; border-color: var(--success); opacity: 0.5; pointer-events: none; }

        /* ACTIVITY 6: SORTING */
        .sorting-area {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .sort-bucket {
            flex: 1;
            border: 2px dashed var(--gold);
            padding: 20px;
            border-radius: 8px;
            min-height: 200px;
            text-align: center;
            transition: background 0.3s;
        }
        .sort-bucket.drag-over { background: rgba(212, 175, 55, 0.1); }
        .bucket-title { font-family: 'Playfair Display', serif; color: var(--gold); margin-bottom: 10px; font-size: 1.2rem; }
        .draggable-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        .draggable {
            background: var(--cream);
            color: var(--navy);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: grab;
            font-weight: bold;
        }

        /* ACTIVITY 7: CHAT SIM */
        .chat-screen {
            background: #fff;
            color: #333;
            border-radius: 12px;
            max-width: 400px;
            margin: 0 auto;
            height: 400px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 4px solid var(--navy-light);
        }
        .chat-header {
            background: var(--success);
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: bold;
        }
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #e5ddd5;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .msg {
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 80%;
            font-size: 0.9rem;
        }
        .msg.received { background: white; align-self: flex-start; border-top-left-radius: 0; }
        .msg.sent { background: #dcf8c6; align-self: flex-end; border-top-right-radius: 0; }
        .chat-options {
            padding: 10px;
            background: #f0f0f0;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .chat-btn {
            background: white;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 20px;
            cursor: pointer;
            text-align: left;
            transition: 0.2s;
        }
        .chat-btn:hover { background: #eee; }

        /* ACTIVITY 8: DICTATION */
        .dictation-box { text-align: center; max-width: 500px; margin: 0 auto; }
        .dictation-input {
            width: 100%;
            padding: 15px;
            margin: 20px 0;
            border: 2px solid var(--gold);
            background: rgba(255,255,255,0.1);
            color: var(--cream);
            font-size: 1.2rem;
            border-radius: 8px;
            text-align: center;
        }

        .btn-main {
            background: var(--gold);
            color: var(--navy);
            border: none;
            padding: 10px 30px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: bold;
            border-radius: 4px;
        }

        .feedback-msg { margin-top: 15px; font-weight: bold; min-height: 24px; text-align: center; }

        /* FOOTER */
        footer {
            text-align: center;
            padding: 2rem;
            border-top: 1px solid rgba(212, 175, 55, 0.3);
            margin-top: auto;
            color: var(--gold);
        }

        /* Mobile Adjustments */
        @media (max-width: 768px) {
            .match-container { grid-template-columns: 1fr; }
            .sorting-area { flex-direction: column; }
            .card { height: 250px; }
            .chat-screen { width: 100%; }
        }
    </style>
</head>
<body>

    <header>
        <div style="font-size: 2rem;">ü§ù</div>
        <h1>Meeting New People</h1>
        <div class="subtitle">Private Lesson ‚Ä¢ Beginner A1-A2</div>
    </header>

    <div class="container">
        <!-- Navigation -->
        <nav class="tabs">
            <button class="tab-btn active" onclick="openTab('story')">1. Story</button>
            <button class="tab-btn" onclick="openTab('vocab')">2. Words</button>
            <button class="tab-btn" onclick="openTab('tf')">3. True/False</button>
            <button class="tab-btn" onclick="openTab('sentence')">4. Builder</button>
            <button class="tab-btn" onclick="openTab('match')">5. Match</button>
            <button class="tab-btn" onclick="openTab('sorting')">6. Sort</button>
            <button class="tab-btn" onclick="openTab('chat')">7. Chat</button>
            <button class="tab-btn" onclick="openTab('dictation')">8. Listen</button>
        </nav>

        <!-- 1. Interactive Story -->
        <div id="story" class="section active">
            <h2>üìñ Yusuf Makes New Friends</h2>
            <p style="margin-bottom: 15px; font-style: italic; color: #aaa;">Click any sentence to listen.</p>
            <div id="story-content" class="story-text"></div>
        </div>

        <!-- 2. Vocabulary -->
        <div id="vocab" class="section">
            <h2>üìá Vocabulary Flashcards</h2>
            <div class="grid" id="vocab-grid"></div>
        </div>

        <!-- 3. True or False -->
        <div id="tf" class="section">
            <h2>‚ùì True or False?</h2>
            <p>Read the sentences about the story. Is it True or False?</p>
            <div class="tf-container" id="tf-container">
                <!-- JS populates this -->
            </div>
            <p id="tf-feedback" class="feedback-msg"></p>
        </div>

        <!-- 4. Sentence Builder -->
        <div id="sentence" class="section">
            <h2>üèóÔ∏è Sentence Builder</h2>
            <p>Click the words in the correct order to form the sentence.</p>
            <div class="scramble-box">
                <h3 id="scramble-hint" style="color:var(--gold); margin-bottom:10px;">Hint: Asking about location</h3>
                <div class="drop-zone" id="scramble-zone"></div>
                <div class="word-bank" id="scramble-bank"></div>
                <button class="btn-main" onclick="resetScramble()" style="margin-top:15px; font-size:0.8rem;">Reset</button>
            </div>
            <p id="scramble-feedback" class="feedback-msg"></p>
            <button class="btn-main" onclick="nextScramble()">Next Sentence ‚û°</button>
        </div>

        <!-- 5. Match Up -->
        <div id="match" class="section">
            <h2>üîó Conversation Match</h2>
            <p>Match the Question (Left) to the Answer (Right).</p>
            <div class="match-container">
                <div class="match-col" id="match-left"></div>
                <div class="match-col" id="match-right"></div>
            </div>
            <p id="match-feedback" class="feedback-msg"></p>
        </div>

        <!-- 6. Sorting Game -->
        <div id="sorting" class="section">
            <h2>üë• Who is it?</h2>
            <p>Drag the words to Yusuf or Selin.</p>
            <div class="draggable-container" id="draggable-source">
                <div class="draggable" draggable="true" ondragstart="drag(event)" id="d1">From Van</div>
                <div class="draggable" draggable="true" ondragstart="drag(event)" id="d2">From Izmir</div>
                <div class="draggable" draggable="true" ondragstart="drag(event)" id="d3">Engineering</div>
                <div class="draggable" draggable="true" ondragstart="drag(event)" id="d4">Literature</div>
                <div class="draggable" draggable="true" ondragstart="drag(event)" id="d5">Sci-Fi Movies</div>
                <div class="draggable" draggable="true" ondragstart="drag(event)" id="d6">Likes Coffee</div>
                <div class="draggable" draggable="true" ondragstart="drag(event)" id="d7">Shy at first</div>
                <div class="draggable" draggable="true" ondragstart="drag(event)" id="d8">Waved Hello</div>
            </div>
            <div class="sorting-area">
                <div class="sort-bucket" ondrop="drop(event, 'yusuf')" ondragover="allowDrop(event)">
                    <div class="bucket-title">üéì Yusuf</div>
                </div>
                <div class="sort-bucket" ondrop="drop(event, 'selin')" ondragover="allowDrop(event)">
                    <div class="bucket-title">üìö Selin</div>
                </div>
            </div>
            <p id="sort-feedback" class="feedback-msg"></p>
        </div>

        <!-- 7. Chat Simulator -->
        <div id="chat" class="section">
            <h2>üí¨ Chat Simulator</h2>
            <p style="margin-bottom:10px;">Choose the polite response to make friends!</p>
            <div class="chat-screen">
                <div class="chat-header">Online Book Club Group</div>
                <div class="chat-messages" id="chat-messages">
                    <div class="msg received">Selin: Hi everyone! I'm Selin from Izmir. üëã</div>
                </div>
                <div class="chat-options" id="chat-options">
                    <button class="chat-btn" onclick="handleChat(0)">Ignore her.</button>
                    <button class="chat-btn" onclick="handleChat(1)">Hi Selin! Nice to meet you.</button>
                </div>
            </div>
        </div>

        <!-- 8. Dictation -->
        <div id="dictation" class="section">
            <h2>üéß Listening Dictation</h2>
            <div class="dictation-box">
                <button class="btn-main" onclick="playDictationWord()">üîä Play Word</button>
                <input type="text" id="dictation-input" class="dictation-input" placeholder="Type what you hear...">
                <button class="btn-main" onclick="checkDictation()">Check Spelling</button>
                <div id="dictation-feedback" class="feedback-msg"></div>
            </div>
        </div>

    </div>

    <footer>
        Private Lesson for Musab ƒ∞kbal SUBA≈ûI ‚Ä¢ Created with Excellence üëë
    </footer>

    <script>
        /* --- 1. STORY DATA & LOGIC --- */
        const storyText = `Yusuf is a student at Van Y√ºz√ºnc√º Yƒ±l University. He studies electrical engineering. Every day, he walks by the beautiful lake. He loves his university, but sometimes he feels a little lonely. He wants to talk to more people and share his university life.
        Today, Yusuf feels a bit shy but also very excited. He decides to join an online book club. He sits at his desk with his laptop. "I want to hear different ideas," he thinks. He hopes the other students are kind.
        The meeting starts. Many faces appear on the screen. Yusuf feels shy, so he keeps his microphone off at first. He sees a girl waving. She looks very happy to be there. Yusuf takes a deep breath and turns on his camera.
        A student named Selin speaks first. "Hello! My name is Selin," she says. Yusuf smiles back. He remembers his English lessons. He asks her, "What is your name?" even though she just said it, to practice his speaking. They both laugh.
        Another student named Emre joins the conversation. He looks a little tired. Yusuf wants to be a good friend. He asks an icebreaker question: "What made you happy today, Emre?" Emre smiles and talks about his morning coffee.
        "Where are you from?" Selin asks Yusuf. Yusuf feels proud. "My hometown is Van," he says. "It is famous for the lake and the cats." Selin says she is from Izmir. They enjoy learning about different cities.
        They talk about their studies. Yusuf explains his favorite subject, electrical engineering. "It is difficult but interesting," he says. Selin likes literature. Yusuf realizes that having different ideas makes the conversation better.
        Soon, they talk about their hobbies. Emre loves playing basketball. Yusuf says, "My hobbies are photography and reading sci-fi." They also talk about their favorite movies. Yusuf loves movies about space and robots.
        "What is your favorite food?" Selin asks. Yusuf thinks of the famous Van breakfast. "I love a big breakfast with honey and cheese!" he says. They promise to meet in real life one day to eat together. Yusuf is no longer sad.
        The meeting ends, and Yusuf closes his laptop. He doesn't feel shy anymore. He feels happy and connected. Meeting new people online was a great idea. He looks forward to the next book club meeting with his new friends.`;

        /* --- 2. VOCAB DATA --- */
        const vocabList = [
            { word: "Ice breaker", icon: "üî®", def: "A question to start a conversation." },
            { word: "Hometown", icon: "üè†", def: "The city where you were born." },
            { word: "University", icon: "üéì", def: "A place for higher education." },
            { word: "Engineering", icon: "‚ö°", def: "Designing machines and structures." },
            { word: "Literature", icon: "üìö", def: "Books, poems, and stories." },
            { word: "Shy", icon: "üôà", def: "Feeling nervous about meeting people." },
            { word: "Excited", icon: "ü§©", def: "Feeling very happy and enthusiastic." },
            { word: "Online", icon: "üíª", def: "Connected to the internet." },
            { word: "Hobbies", icon: "üé®", def: "Fun activities in free time." },
            { word: "Lonely", icon: "üòî", def: "Sad because you have no friends with you." }
        ];

        /* --- 3. TRUE/FALSE DATA --- */
        const tfQuestions = [
            { q: "Yusuf studies Literature at university.", a: false },
            { q: "Selin is from Izmir.", a: true },
            { q: "Emre was happy about his morning coffee.", a: true },
            { q: "Yusuf hates sci-fi movies.", a: false },
            { q: "They met in a real library.", a: false }
        ];

        /* --- 4. SENTENCE BUILDER DATA --- */
        const sentences = [
            { text: "Where are you from", hint: "Asking about location" },
            { text: "What is your name", hint: "Asking identity" },
            { text: "I like reading books", hint: "Stating a hobby" },
            { text: "Do you have a pet", hint: "Asking about animals" }
        ];
        let currentSentenceIdx = 0;
        let builtSentence = [];

        /* --- 5. MATCHING DATA --- */
        const matchPairs = [
            { q: "What is your name?", a: "My name is Yusuf." },
            { q: "Where do you live?", a: "I live in Van." },
            { q: "How are you?", a: "I am fine, thanks." },
            { q: "What is your hobby?", a: "I like photography." }
        ];
        let selectedLeft = null;

        /* --- 6. SORTING DATA --- */
        const sortData = {
            'd1': 'yusuf', 'd2': 'selin', 'd3': 'yusuf', 'd4': 'selin',
            'd5': 'yusuf', 'd6': 'selin', 'd7': 'yusuf', 'd8': 'selin' 
            // Note: d6 changed to "Likes Coffee" which was Emre, but for game let's say Selin agreed or assign "Waved Hello" to Selin
            // Correction based on story: Emre had coffee. Let's change d6 to "Waved Hello" (Selin) in HTML logic or accept Emre details.
            // Simplified: d6 in HTML is "Likes Coffee" -> Emre. Let's change HTML text to something Selin did. 
            // Update: Changed d6 in HTML to "Likes Coffee" -> Actually Emre. 
            // Let's update HTML text d6 to "First to speak" (Selin) for accuracy.
        };

        /* --- 7. CHAT DATA --- */
        const chatSteps = [
            {
                msg: "Selin: What do you study, Yusuf?",
                opts: [
                    { txt: "I study Electrical Engineering.", correct: true },
                    { txt: "I study sleeping.", correct: false }
                ]
            },
            {
                msg: "Selin: That sounds difficult! I study Literature.",
                opts: [
                    { txt: "Books are boring.", correct: false },
                    { txt: "Wow, that sounds interesting!", correct: true }
                ]
            },
            {
                msg: "Selin: Do you want to meet for breakfast one day?",
                opts: [
                    { txt: "Yes, I love Van breakfast!", correct: true },
                    { txt: "No, I am busy forever.", correct: false }
                ]
            }
        ];
        let chatStepIdx = 0;

        /* --- INITIALIZATION --- */
        window.onload = function() {
            initStory();
            initVocab();
            initTF();
            loadScramble(0);
            initMatch();
        };

        function speak(text) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = 0.9;
            window.speechSynthesis.speak(utterance);
        }

        /* --- TAB LOGIC --- */
        function openTab(tabName) {
            document.querySelectorAll('.section').forEach(x => x.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        /* --- 1. STORY LOGIC --- */
        function initStory() {
            const container = document.getElementById('story-content');
            const sentencesArr = storyText.match( /[^\.!\?]+[\.!\?]+/g );
            sentencesArr.forEach(sentence => {
                const span = document.createElement('span');
                span.className = 'story-sentence';
                span.textContent = sentence.trim() + " ";
                span.onclick = function() {
                    document.querySelectorAll('.story-sentence').forEach(s => s.classList.remove('playing'));
                    this.classList.add('playing');
                    speak(sentence);
                };
                container.appendChild(span);
            });
        }

        /* --- 2. VOCAB LOGIC --- */
        function initVocab() {
            const grid = document.getElementById('vocab-grid');
            vocabList.forEach(item => {
                const card = document.createElement('div');
                card.className = 'card';
                card.onclick = function() { this.classList.toggle('flipped'); };
                card.innerHTML = `
                    <div class="card-inner">
                        <div class="card-front">
                            <div class="card-icon">${item.icon}</div>
                            <div class="card-word">${item.word}</div>
                            <small style="margin-top:10px; opacity:0.7;">Click to flip</small>
                        </div>
                        <div class="card-back">
                            <div class="card-def">${item.def}</div>
                            <button onclick="event.stopPropagation(); speak('${item.word}')" style="margin-top:15px; padding:5px 10px; background:var(--gold); border:none; border-radius:4px; cursor:pointer;">üîä Listen</button>
                        </div>
                    </div>`;
                grid.appendChild(card);
            });
        }

        /* --- 3. TRUE/FALSE LOGIC --- */
        function initTF() {
            const container = document.getElementById('tf-container');
            tfQuestions.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'tf-item';
                div.innerHTML = `
                    <span>${index + 1}. ${item.q}</span>
                    <div>
                        <button class="tf-btn" onclick="checkTF(this, ${item.a}, true)">True</button>
                        <button class="tf-btn" onclick="checkTF(this, ${item.a}, false)">False</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function checkTF(btn, correctAnswer, userAnswer) {
            const parent = btn.parentElement;
            // Reset buttons
            parent.querySelectorAll('.tf-btn').forEach(b => {
                b.classList.remove('correct', 'wrong');
                b.disabled = true;
            });
            
            const feedback = document.getElementById('tf-feedback');
            if (userAnswer === correctAnswer) {
                btn.classList.add('correct');
                feedback.textContent = "Correct! Well done.";
                feedback.style.color = "#2ecc71";
            } else {
                btn.classList.add('wrong');
                feedback.textContent = "Oops! That's not right.";
                feedback.style.color = "#e74c3c";
            }
        }

        /* --- 4. SENTENCE BUILDER LOGIC --- */
        function loadScramble(idx) {
            currentSentenceIdx = idx;
            builtSentence = [];
            const data = sentences[idx];
            document.getElementById('scramble-hint').textContent = "Hint: " + data.hint;
            const zone = document.getElementById('scramble-zone');
            const bank = document.getElementById('scramble-bank');
            zone.innerHTML = '';
            bank.innerHTML = '';
            document.getElementById('scramble-feedback').textContent = '';

            // Shuffle words
            const words = data.text.split(' ').sort(() => Math.random() - 0.5);
            
            words.forEach(word => {
                const el = document.createElement('div');
                el.className = 'scramble-word';
                el.textContent = word;
                el.onclick = function() {
                    // Move to zone
                    if (el.parentElement === bank) {
                        zone.appendChild(el);
                        builtSentence.push(word);
                    } else {
                        // Move back to bank
                        bank.appendChild(el);
                        builtSentence = builtSentence.filter(w => w !== word);
                    }
                    checkScramble();
                };
                bank.appendChild(el);
            });
        }

        function checkScramble() {
            const currentTarget = sentences[currentSentenceIdx].text.split(' ').join('');
            const currentBuilt = Array.from(document.getElementById('scramble-zone').children).map(c => c.textContent).join('');
            const feedback = document.getElementById('scramble-feedback');
            
            if (currentBuilt === currentTarget) {
                feedback.textContent = "‚úÖ Correct Sentence!";
                feedback.style.color = "#2ecc71";
                speak(sentences[currentSentenceIdx].text);
            } else if (document.getElementById('scramble-bank').children.length === 0) {
                 feedback.textContent = "‚ùå Incorrect order. Try resetting.";
                 feedback.style.color = "#e74c3c";
            } else {
                feedback.textContent = "";
            }
        }

        function resetScramble() { loadScramble(currentSentenceIdx); }
        function nextScramble() {
            let next = (currentSentenceIdx + 1) % sentences.length;
            loadScramble(next);
        }

        /* --- 5. MATCHING LOGIC --- */
        function initMatch() {
            const leftCol = document.getElementById('match-left');
            const rightCol = document.getElementById('match-right');
            
            // Randomize pairs
            const lefts = matchPairs.map((p, i) => ({txt: p.q, id: i})).sort(() => Math.random() - 0.5);
            const rights = matchPairs.map((p, i) => ({txt: p.a, id: i})).sort(() => Math.random() - 0.5);

            leftCol.innerHTML = ''; rightCol.innerHTML = '';

            lefts.forEach(item => {
                const card = document.createElement('div');
                card.className = 'match-card';
                card.textContent = item.txt;
                card.dataset.id = item.id;
                card.onclick = () => selectLeft(card);
                leftCol.appendChild(card);
            });

            rights.forEach(item => {
                const card = document.createElement('div');
                card.className = 'match-card';
                card.textContent = item.txt;
                card.dataset.id = item.id;
                card.onclick = () => selectRight(card);
                rightCol.appendChild(card);
            });
        }

        function selectLeft(card) {
            if (card.classList.contains('matched')) return;
            // Deselect others
            document.querySelectorAll('#match-left .match-card').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            selectedLeft = card;
        }

        function selectRight(card) {
            if (!selectedLeft || card.classList.contains('matched')) return;
            
            const feedback = document.getElementById('match-feedback');
            if (selectedLeft.dataset.id === card.dataset.id) {
                // Match
                selectedLeft.classList.add('matched');
                card.classList.add('matched');
                selectedLeft.classList.remove('selected');
                feedback.textContent = "It's a match!";
                feedback.style.color = "#2ecc71";
                selectedLeft = null;
            } else {
                feedback.textContent = "Not a match. Try again.";
                feedback.style.color = "#e74c3c";
            }
        }

        /* --- 6. SORTING LOGIC --- */
        function allowDrop(ev) { ev.preventDefault(); document.querySelectorAll('.sort-bucket').forEach(b => b.classList.add('drag-over')); }
        function drag(ev) { ev.dataTransfer.setData("text", ev.target.id); }
        function drop(ev, targetPerson) {
            ev.preventDefault();
            document.querySelectorAll('.sort-bucket').forEach(b => b.classList.remove('drag-over'));
            const data = ev.dataTransfer.getData("text");
            const draggedElement = document.getElementById(data);
            const feedback = document.getElementById('sort-feedback');

            // Hardcoded fixes for new items
            // d6 is "Likes Coffee" -> Emre? No, I labelled d6 as "Likes Coffee" in HTML but that was Emre. 
            // Let's assume user drags it to "Emre" (not a bucket) or just treat it as Wrong for both?
            // Wait, I updated HTML labels.
            // d1: Van (Yusuf), d2: Izmir (Selin), d3: Eng (Yusuf), d4: Lit (Selin)
            // d5: SciFi (Yusuf), d6: Coffee (Emre - tricky), d7: Shy (Yusuf), d8: Waved (Selin)
            
            // Allow Coffee to match NO ONE or provide Feedback?
            // Actually, in previous code "d6" was mapped to "damla".
            // Let's map d6 to Selin for the sake of gameplay flow (maybe she likes coffee too?) 
            // OR change d6 text in HTML. I will treat d6 as "selin" in logic for now, or change d6 in logic.
            
            // Logic Check:
            let correct = false;
            if (targetPerson === 'yusuf' && ['d1','d3','d5','d7'].includes(data)) correct = true;
            if (targetPerson === 'selin' && ['d2','d4','d8'].includes(data)) correct = true;
            
            if (data === 'd6') {
                 feedback.textContent = "Wait! In the story, Emre liked coffee, not Yusuf or Selin!";
                 feedback.style.color = "orange";
                 return;
            }

            if (correct) {
                ev.target.closest('.sort-bucket').appendChild(draggedElement);
                draggedElement.style.background = '#2ecc71';
                feedback.textContent = "Correct!";
                feedback.style.color = "#2ecc71";
            } else {
                feedback.textContent = "Try the other person.";
                feedback.style.color = "#e74c3c";
            }
        }

        /* --- 7. CHAT LOGIC --- */
        function handleChat(choiceIdx) {
            const data = chatSteps[chatStepIdx];
            const messages = document.getElementById('chat-messages');
            
            // Add user choice
            const userMsg = document.createElement('div');
            userMsg.className = 'msg sent';
            userMsg.textContent = data.opts[choiceIdx].txt;
            messages.appendChild(userMsg);

            if (data.opts[choiceIdx].correct) {
                // Correct
                chatStepIdx++;
                setTimeout(() => {
                    if (chatStepIdx < chatSteps.length) {
                        const reply = document.createElement('div');
                        reply.className = 'msg received';
                        reply.textContent = chatSteps[chatStepIdx].msg;
                        messages.appendChild(reply);
                        messages.scrollTop = messages.scrollHeight;
                        updateChatButtons();
                    } else {
                        const end = document.createElement('div');
                        end.className = 'msg received';
                        end.textContent = "Selin: Great! See you then! üëã";
                        messages.appendChild(end);
                        document.getElementById('chat-options').innerHTML = '<div style="text-align:center; color:green; font-weight:bold;">Conversation Complete!</div>';
                    }
                }, 1000);
            } else {
                // Incorrect
                setTimeout(() => {
                    const error = document.createElement('div');
                    error.className = 'msg received';
                    error.style.background = '#ffdddd';
                    error.textContent = "Selin looks confused... (Try a more polite answer!)";
                    messages.appendChild(error);
                    messages.scrollTop = messages.scrollHeight;
                    // Reset step visually? Or just let them try again?
                    // Simple: Undo user msg and let them try again
                    setTimeout(() => {
                        userMsg.remove();
                        error.remove();
                    }, 1500);
                }, 500);
            }
            messages.scrollTop = messages.scrollHeight;
        }

        function updateChatButtons() {
            const btns = document.querySelectorAll('.chat-btn');
            const data = chatSteps[chatStepIdx];
            btns[0].textContent = data.opts[0].txt;
            btns[1].textContent = data.opts[1].txt;
        }

        /* --- 8. DICTATION LOGIC --- */
        let currentDictationWord = "";
        function playDictationWord() {
            const randIndex = Math.floor(Math.random() * vocabList.length);
            currentDictationWord = vocabList[randIndex].word;
            speak(currentDictationWord);
        }

        function checkDictation() {
            const userText = document.getElementById('dictation-input').value.trim().toLowerCase();
            const feedback = document.getElementById('dictation-feedback');
            
            if (!currentDictationWord) {
                feedback.textContent = "Please click 'Play Word' first.";
                return;
            }

            if (userText === currentDictationWord.toLowerCase()) {
                feedback.textContent = "‚úÖ Correct! Excellent spelling.";
                feedback.style.color = "#2ecc71";
            } else {
                feedback.textContent = `‚ùå Incorrect. The word was: ${currentDictationWord}`;
                feedback.style.color = "#e74c3c";
            }
        }
    </script>
</body>
</html>
