<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Lessons with Musab Ä°kbal SUBAÅžI</title>
    <style>
        /* --- DESIGN SYSTEM EXTRACTED FROM PROVIDED THEME --- */
        
        /* --- FONTS --- */
        @import url('https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:wght@400;600;700&display=swap');

        /* --- VARIABLES --- */
        :root {
            --navy: #0A192F;
            --navy-light: #172a45;
            --gold: #D4AF37;
            --gold-light: #f3cf55;
            --cream: #F8F8F0;
            --white: #ffffff;
            --success: #2ecc71;
            --error: #e74c3c;
            --shadow: 0 10px 30px -10px rgba(2, 12, 27, 0.7);
            --highlight: rgba(212, 175, 55, 0.3);
        }

        /* --- RESET & BASE --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            background-color: var(--navy);
            color: var(--navy);
            font-family: 'Lato', sans-serif;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        h1, h2, h3 {
            font-family: 'Playfair Display', serif;
            color: var(--navy);
        }

        /* --- HEADER --- */
        header {
            background-color: var(--navy);
            color: var(--gold);
            padding: 2rem 1rem;
            text-align: center;
            border-bottom: 2px solid var(--gold);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            position: relative;
            z-index: 10;
        }

        header h1 {
            color: var(--gold);
            font-size: 2.2rem;
            letter-spacing: 1px;
            margin-bottom: 0.5rem;
        }

        header p {
            color: var(--cream);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 300;
        }

        /* --- CONTAINER --- */
        .container {
            max-width: 1000px;
            margin: 2rem auto;
            background: var(--cream);
            border-radius: 8px;
            box-shadow: var(--shadow);
            overflow: hidden;
            flex: 1;
            width: 95%;
            display: flex;
            flex-direction: column;
        }

        /* --- NAVIGATION --- */
        .tabs {
            display: flex;
            flex-wrap: wrap;
            background: var(--navy-light);
        }

        .tab-btn {
            flex: 1;
            padding: 1.2rem;
            background: transparent;
            border: none;
            color: var(--cream);
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 4px solid transparent;
            min-width: 140px;
        }

        .tab-btn:hover {
            background: rgba(212, 175, 55, 0.1);
            color: var(--gold);
        }

        .tab-btn.active {
            color: var(--gold);
            border-bottom: 4px solid var(--gold);
            background: rgba(10, 25, 47, 0.5);
        }

        /* --- SECTIONS --- */
        .section {
            display: none;
            padding: 2rem;
            animation: fadeIn 0.5s ease;
            min-height: 500px;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            text-align: center;
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: var(--navy);
        }

        .section-subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 2rem;
            font-style: italic;
            border-bottom: 1px solid var(--gold);
            padding-bottom: 1rem;
            display: block;
            margin-left: auto;
            margin-right: auto;
            width: 80%;
        }

        /* --- BUTTONS --- */
        .btn {
            padding: 0.8rem 1.5rem;
            background-color: var(--navy);
            color: var(--gold);
            border: 1px solid var(--gold);
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Lato', sans-serif;
            font-weight: 700;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .btn:hover {
            background-color: var(--gold);
            color: var(--navy);
        }

        .btn-small {
            padding: 0.4rem 0.8rem;
            font-size: 0.75rem;
            border-radius: 20px;
        }

        /* --- ACTIVITY 1: SMART READER --- */
        .story-container {
            font-size: 1.2rem;
            line-height: 2;
            color: #333;
            text-align: justify;
        }

        .story-sentence {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .story-sentence:hover {
            background-color: rgba(212, 175, 55, 0.1);
        }

        .story-sentence.active-sentence {
            background-color: var(--highlight);
            color: var(--navy);
            font-weight: 600;
        }

        /* --- ACTIVITY 2: FLASHCARDS --- */
        .flashcard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            padding: 1rem;
        }

        .flashcard {
            background-color: transparent;
            perspective: 1000px;
            height: 220px;
            cursor: pointer;
        }

        .flashcard-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .flashcard.flipped .flashcard-inner {
            transform: rotateY(180deg);
        }

        .flashcard-front, .flashcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            border: 2px solid var(--navy);
            padding: 1.5rem;
        }

        .flashcard-front {
            background-color: var(--white);
            color: var(--navy);
        }

        .flashcard-back {
            background-color: var(--navy);
            color: var(--gold);
            transform: rotateY(180deg);
        }

        .word-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .pos-tag {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #666;
            margin-bottom: 1rem;
        }

        /* --- ACTIVITY 3: DICTATION --- */
        .dictation-item {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
            border-left: 5px solid var(--gold);
        }

        .dictation-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        input[type="text"] {
            width: 100%;
            padding: 1rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: 'Lato', sans-serif;
            font-size: 1.1rem;
            outline: none;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus {
            border-color: var(--navy);
        }

        .feedback {
            margin-top: 1rem;
            font-weight: bold;
            min-height: 1.5rem;
        }
        .correct { color: var(--success); }
        .incorrect { color: var(--error); }

        /* --- ACTIVITY 4: GRAMMAR (WORD BANK MODE) --- */
        .gap-container {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        .word-bank {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 2rem;
            padding: 1rem;
            background: var(--navy-light);
            border-radius: 8px;
        }

        .bank-word {
            background: var(--cream);
            color: var(--navy);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            font-weight: bold;
            transition: all 0.2s;
            user-select: none;
        }

        .bank-word:hover {
            transform: translateY(-2px);
        }

        .bank-word.selected {
            background: var(--gold);
            border-color: var(--white);
            box-shadow: 0 0 10px var(--gold);
        }

        .bank-word.used {
            opacity: 0.3;
            cursor: default;
            transform: none;
            background: #ccc;
        }

        .grammar-sentence {
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
            line-height: 2;
        }

        .gap-slot {
            display: inline-block;
            min-width: 120px;
            height: 2rem;
            border-bottom: 3px solid var(--navy);
            color: var(--gold); /* Text color when filled */
            text-align: center;
            cursor: pointer;
            margin: 0 5px;
            font-weight: bold;
            vertical-align: bottom;
            transition: all 0.2s;
            background: rgba(10, 25, 47, 0.05);
            border-radius: 4px 4px 0 0;
            padding: 0 10px;
        }

        .gap-slot:hover {
            background: rgba(10, 25, 47, 0.1);
        }

        .gap-slot.filled {
            border-bottom-color: var(--gold);
        }
        
        .gap-slot.correct {
            color: var(--success);
            border-bottom-color: var(--success);
        }
        
        .gap-slot.incorrect {
            color: var(--error);
            border-bottom-color: var(--error);
        }

        /* --- READER QUIZ ADDITIONS --- */
        .reader-quiz-container {
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid var(--gold);
        }
        
        .quiz-question-card {
            background: white;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            border-left: 4px solid var(--navy);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .quiz-question-text {
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--navy);
        }

        .quiz-option {
            display: block;
            margin-bottom: 0.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .quiz-option:hover {
            background: #f0f4f8;
        }

        /* --- ACTIVITY 5: SCRAMBLE --- */
        .scramble-wrapper {
            background: white;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: 8px;
            border: 1px solid #eee;
        }

        .pool-area {
            min-height: 60px;
            padding: 10px;
            border-radius: 4px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 10px;
        }

        .source-pool {
            background-color: #f0f4f8;
        }

        .dest-pool {
            border: 2px dashed var(--navy);
            background-color: rgba(212, 175, 55, 0.05);
        }

        .drag-word {
            background: var(--navy);
            color: var(--white);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            user-select: none;
            transition: transform 0.2s, background 0.2s;
            font-weight: 600;
        }

        .drag-word:hover {
            transform: translateY(-2px);
            background: var(--gold);
            color: var(--navy);
        }

        /* --- FOOTER --- */
        footer {
            background-color: var(--navy);
            color: var(--cream);
            padding: 2rem 1rem;
            text-align: center;
            margin-top: auto;
            border-top: 1px solid var(--gold);
        }

        .stats-grid {
            display: flex;
            justify-content: center;
            gap: 3rem;
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-val {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            color: var(--gold);
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.8;
        }

        /* --- UTILS --- */
        .hidden { display: none; }
        .text-center { text-align: center; }
        .mt-2 { margin-top: 2rem; }

        @media (max-width: 768px) {
            .tabs { flex-direction: column; }
            .tab-btn { border-bottom: 1px solid rgba(255,255,255,0.1); border-left: 4px solid transparent; }
            .tab-btn.active { border-bottom: 1px solid rgba(255,255,255,0.1); border-left: 4px solid var(--gold); }
            header h1 { font-size: 1.6rem; }
            .section { padding: 1rem; }
            .stats-grid { gap: 1.5rem; }
        }
    </style>
</head>
<body>

    <header>
        <h1>Private Lessons with Musab Ä°kbal SUBAÅžI</h1>
        <p>Premium Curriculum â€¢ The Equilibrium of Saturday</p>
    </header>

    <div class="container">
        <!-- NAVIGATION -->
        <nav class="tabs">
            <button class="tab-btn active" onclick="app.switchTab('reader')">Smart Reader</button>
            <button class="tab-btn" onclick="app.switchTab('flashcards')">Flashcards</button>
            <button class="tab-btn" onclick="app.switchTab('grammar')">Grammar</button>
            <button class="tab-btn" onclick="app.switchTab('dictation')">Dictation</button>
            <button class="tab-btn" onclick="app.switchTab('scramble')">Sentence Builder</button>
        </nav>

        <!-- 1. SMART READER -->
        <div id="reader" class="section active">
            <h2 class="section-title">Interactive Story Reader</h2>
            <span class="section-subtitle">Click any sentence to hear it read aloud and see the text highlighted.</span>
            <div id="story-content" class="story-container">
                <!-- Content injected by JS -->
            </div>

            <!-- NEW QUIZ SECTION -->
            <div class="reader-quiz-container">
                <h3 class="section-title" style="font-size: 1.5rem;">Quick Comprehension Check</h3>
                <div id="reader-quiz-list">
                    <!-- Quiz injected by JS -->
                </div>
                <div class="text-center mt-2">
                    <button class="btn" onclick="app.checkReaderQuiz()">Submit Answers</button>
                    <div id="reader-quiz-feedback" class="feedback"></div>
                </div>
            </div>
        </div>

        <!-- 2. FLASHCARDS -->
        <div id="flashcards" class="section">
            <h2 class="section-title">Vocabulary Mastery</h2>
            <span class="section-subtitle">Key terms from the text. Click to reveal definitions.</span>
            <div id="flashcards-container" class="flashcard-grid">
                <!-- Content injected by JS -->
            </div>
        </div>

        <!-- 3. GRAMMAR -->
        <div id="grammar" class="section">
            <h2 class="section-title">Grammar Gap-Fill</h2>
            <span class="section-subtitle">Fill in the missing words based on the story context.</span>
            <div class="gap-container" id="grammar-container">
                <!-- Content injected by JS -->
            </div>
            <div class="text-center mt-2">
                <button class="btn" onclick="app.checkGrammar()">Check Answers</button>
                <div id="grammar-result" class="feedback"></div>
            </div>
        </div>

        <!-- 4. DICTATION -->
        <div id="dictation" class="section">
            <h2 class="section-title">Audio Dictation</h2>
            <span class="section-subtitle">Listen to the excerpt and type exactly what you hear.</span>
            <div id="dictation-list">
                <!-- Content injected by JS -->
            </div>
        </div>

        <!-- 5. SCRAMBLE -->
        <div id="scramble" class="section">
            <h2 class="section-title">Sentence Reconstruction</h2>
            <span class="section-subtitle">Click words in the gray box to move them to the answer box.</span>
            <div id="scramble-list">
                <!-- Content injected by JS -->
            </div>
        </div>
    </div>

    <footer>
        <div class="stats-grid">
            <div class="stat-item">
                <span class="stat-val" id="score-vocab">0</span>
                <span class="stat-label">Vocab Cards</span>
            </div>
            <div class="stat-item">
                <span class="stat-val" id="score-grammar">0</span>
                <span class="stat-label">Grammar Pts</span>
            </div>
            <div class="stat-item">
                <span class="stat-val" id="score-dictation">0</span>
                <span class="stat-label">Dictation</span>
            </div>
            <div class="stat-item">
                <span class="stat-val" id="score-scramble">0</span>
                <span class="stat-label">Sentences Built</span>
            </div>
        </div>
        <p style="margin-top: 1.5rem; font-size: 0.8rem; opacity: 0.6;">&copy; 2025 Musab Ä°kbal SUBAÅžI - Private English Curriculum</p>
    </footer>

    <script>
        // --- DATA SOURCE ---
        const storyText = `The dawn had barely broken, yet Kenan, who had just celebrated his fourth birthday, was already fully cognizant of the glorious weekend that stretched ahead. He was unequivocally cheerful, bouncing on his small, blue mattress. Unlike the weekdays, when his parents were perpetually tethered to their demanding occupations, Saturdays were earmarked exclusively for exhilarating family pursuits. Adjacent to Kenanâ€™s room, Damla was already immersed in the quiet productivity that defined her academic work. As an accomplished research scientist, her mornings often entailed reviewing complex data, even when she wasn't mandated to be on campus. Meanwhile, Furkan, the family physician, finally permitted himself a prolonged period of slumber. Having spent the previous day treating a particularly difficult cohort of patients, he was utterly depleted. His job required remarkable composure and constant vigilance, making the ability to entirely disconnect from his responsibilities during the weekend an essential prerequisite for maintaining his equilibrium.`;

        const vocabData = [
            { word: "Cognizant", pos: "adj.", def: "Having knowledge or being aware of something.", context: "Kenan was fully cognizant of the weekend." },
            { word: "Unequivocally", pos: "adv.", def: "In a way that leaves no doubt.", context: "He was unequivocally cheerful." },
            { word: "Earmarked", pos: "verb", def: "Designated for a particular purpose.", context: "Saturdays were earmarked for family pursuits." },
            { word: "Indispensable", pos: "adj.", def: "Absolutely necessary.", context: "She considered this time indispensable." },
            { word: "Equilibrium", pos: "noun", def: "A state of physical or mental balance.", context: "Maintaining his equilibrium." },
            { word: "Vigilance", pos: "noun", def: "The action of keeping careful watch.", context: "Job required constant vigilance." }
        ];

        const grammarData = [
            { split: ["Saturdays were ", " exclusively for exhilarating family pursuits."], answer: "earmarked" },
            { split: ["Furkan finally ", " himself a prolonged period of slumber."], answer: "permitted" },
            { split: ["He was ", " depleted after treating patients."], answer: "utterly" },
            { split: ["Damla was ", " in the quiet productivity of her work."], answer: "immersed" }
        ];

        const dictationData = [
            "The dawn had barely broken.",
            "He was unequivocally cheerful.",
            "Are you feeling quite rested my dear?"
        ];

        const scrambleData = [
            "The family converged in the kitchen a hub of activity.",
            "Dad is exceptionally strong and manages to reassure people.",
            "This shared pastime was one activity the entire family relished."
        ];

        const readerQuizData = [
            { 
                q: "What is Damla's profession according to the text?", 
                options: ["Family Physician", "Research Scientist", "School Teacher"], 
                correct: 1 
            },
            { 
                q: "Why is the weekend hike indispensable for Furkan?", 
                options: ["It helps maintain his equilibrium", "He needs to collect samples", "He wants to avoid patients"], 
                correct: 0 
            },
            { 
                q: "How is Kenan described at the start of the story?", 
                options: ["Utterly depleted", "Mildly anxious", "Unequivocally cheerful"], 
                correct: 2 
            }
        ];

        // --- APP LOGIC ---
        const app = {
            scores: { vocab: 0, grammar: 0, dictation: 0, scramble: 0, quiz: 0 },
            
            init: function() {
                this.renderReader();
                this.renderReaderQuiz(); // New Init Call
                this.renderFlashcards();
                this.renderGrammar();
                this.renderDictation();
                this.renderScramble();
            },

            // TAB SWITCHING
            switchTab: function(tabId) {
                document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
                
                document.getElementById(tabId).classList.add('active');
                // Find button that calls this function with specific tabId to highlight it
                // Using event.currentTarget if available, else loop
                if (event && event.currentTarget) {
                    event.currentTarget.classList.add('active');
                }
            },

            // SPEECH SYNTHESIS
            speak: function(text) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 0.9;
                window.speechSynthesis.speak(utterance);
            },

            // 1. READER LOGIC
            renderReader: function() {
                const container = document.getElementById('story-content');
                // Split by regex looking for sentence endings (.!?) but keeping the delimiter
                const sentences = storyText.match(/[^.!?]+[.!?]+/g) || [storyText];
                
                sentences.forEach(sentence => {
                    const span = document.createElement('span');
                    span.className = 'story-sentence';
                    span.textContent = sentence + " ";
                    span.onclick = () => {
                        // Highlight
                        document.querySelectorAll('.story-sentence').forEach(s => s.classList.remove('active-sentence'));
                        span.classList.add('active-sentence');
                        // Read
                        this.speak(sentence);
                    };
                    container.appendChild(span);
                });
            },

            // 1.5 READER QUIZ LOGIC
            renderReaderQuiz: function() {
                const container = document.getElementById('reader-quiz-list');
                readerQuizData.forEach((item, idx) => {
                    const div = document.createElement('div');
                    div.className = 'quiz-question-card';
                    
                    let optionsHTML = '';
                    item.options.forEach((opt, optIdx) => {
                        optionsHTML += `
                            <label class="quiz-option">
                                <input type="radio" name="rq-${idx}" value="${optIdx}">
                                ${opt}
                            </label>
                        `;
                    });

                    div.innerHTML = `
                        <div class="quiz-question-text">${idx + 1}. ${item.q}</div>
                        <div>${optionsHTML}</div>
                    `;
                    container.appendChild(div);
                });
            },

            checkReaderQuiz: function() {
                let correctCount = 0;
                readerQuizData.forEach((item, idx) => {
                    const selected = document.querySelector(`input[name="rq-${idx}"]:checked`);
                    const card = document.querySelectorAll('.quiz-question-card')[idx];
                    
                    // Reset style
                    card.style.borderLeftColor = 'var(--navy)';

                    if (selected) {
                        if (parseInt(selected.value) === item.correct) {
                            correctCount++;
                            card.style.borderLeftColor = 'var(--success)';
                        } else {
                            card.style.borderLeftColor = 'var(--error)';
                        }
                    }
                });

                const fb = document.getElementById('reader-quiz-feedback');
                fb.textContent = `You scored ${correctCount} / ${readerQuizData.length}`;
                fb.className = correctCount === readerQuizData.length ? "feedback correct" : "feedback incorrect";
            },

            // 2. FLASHCARD LOGIC
            renderFlashcards: function() {
                const container = document.getElementById('flashcards-container');
                vocabData.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'flashcard';
                    card.innerHTML = `
                        <div class="flashcard-inner">
                            <div class="flashcard-front">
                                <div class="word-title">${item.word}</div>
                                <div class="pos-tag">${item.pos}</div>
                                <div style="font-size:0.8rem; color:#888;">Tap to flip</div>
                            </div>
                            <div class="flashcard-back">
                                <p style="font-weight:bold; margin-bottom:10px;">${item.def}</p>
                                <p style="font-style:italic; font-size:0.9rem; margin-bottom:15px;">"${item.context}"</p>
                                <button class="btn btn-small" onclick="event.stopPropagation(); app.speak('${item.word}')">ðŸ”Š Listen</button>
                            </div>
                        </div>
                    `;
                    card.onclick = (e) => {
                        if (e.target.tagName !== 'BUTTON') {
                            card.classList.toggle('flipped');
                            if (card.classList.contains('flipped') && !card.dataset.viewed) {
                                card.dataset.viewed = "true";
                                this.scores.vocab++;
                                this.updateUI();
                            }
                        }
                    };
                    container.appendChild(card);
                });
            },

            // 3. GRAMMAR LOGIC (Word Bank Version)
            selectedWord: null, // Track selected bank word

            renderGrammar: function() {
                const container = document.getElementById('grammar-container');
                container.innerHTML = ''; // Clear previous content

                // 1. Create Word Bank
                const bankDiv = document.createElement('div');
                bankDiv.className = 'word-bank';
                
                // Get all answers and shuffle
                const words = grammarData.map((item, idx) => ({ text: item.answer, id: idx }));
                // Simple shuffle
                words.sort(() => Math.random() - 0.5);

                words.forEach(w => {
                    const btn = document.createElement('div');
                    btn.className = 'bank-word';
                    btn.textContent = w.text;
                    btn.dataset.word = w.text;
                    btn.onclick = (e) => this.selectBankWord(e.target);
                    bankDiv.appendChild(btn);
                });

                container.appendChild(bankDiv);

                // 2. Create Sentences
                grammarData.forEach((item, idx) => {
                    const div = document.createElement('div');
                    div.className = 'grammar-sentence';
                    div.innerHTML = `
                        <span>${idx + 1}. ${item.split[0]}</span>
                        <span class="gap-slot" data-correct="${item.answer}" onclick="app.fillGap(this)"></span>
                        <span>${item.split[1]}</span>
                    `;
                    container.appendChild(div);
                });
            },

            selectBankWord: function(el) {
                if (el.classList.contains('used')) return;

                // Deselect others
                document.querySelectorAll('.bank-word').forEach(b => b.classList.remove('selected'));
                
                // Select this one
                el.classList.add('selected');
                this.selectedWord = el;
            },

            fillGap: function(slot) {
                // If slot is already filled, return word to bank
                if (slot.textContent) {
                    const wordText = slot.textContent;
                    // Find the bank button for this word and un-use it
                    const buttons = document.querySelectorAll('.bank-word');
                    for (let btn of buttons) {
                        if (btn.textContent === wordText && btn.classList.contains('used')) {
                            btn.classList.remove('used');
                            break;
                        }
                    }
                    slot.textContent = '';
                    slot.classList.remove('filled', 'correct', 'incorrect');
                }

                // If we have a selected word from bank, place it
                if (this.selectedWord) {
                    slot.textContent = this.selectedWord.textContent;
                    slot.classList.add('filled');
                    
                    // Mark bank word as used
                    this.selectedWord.classList.remove('selected');
                    this.selectedWord.classList.add('used');
                    this.selectedWord = null;
                }
            },

            checkGrammar: function() {
                let correctCount = 0;
                const slots = document.querySelectorAll('.gap-slot');
                
                slots.forEach(slot => {
                    const userWord = slot.textContent.trim().toLowerCase();
                    const correctWord = slot.dataset.correct.toLowerCase();
                    
                    if (userWord === correctWord) {
                        slot.className = 'gap-slot correct';
                        correctCount++;
                    } else {
                        slot.className = 'gap-slot incorrect';
                    }
                });
                
                this.scores.grammar = correctCount;
                this.updateUI();
                
                const result = document.getElementById('grammar-result');
                result.textContent = `You got ${correctCount} / ${slots.length} correct.`;
                result.className = correctCount === slots.length ? "feedback correct" : "feedback incorrect";
            },

            // 4. DICTATION LOGIC
            renderDictation: function() {
                const container = document.getElementById('dictation-list');
                dictationData.forEach((sent, idx) => {
                    const div = document.createElement('div');
                    div.className = 'dictation-item';
                    div.innerHTML = `
                        <div class="dictation-controls">
                            <strong>Phrase #${idx+1}</strong>
                            <button class="btn btn-small" onclick="app.speak('${sent.replace(/'/g, "\\'")}')">ðŸ”Š Play Audio</button>
                        </div>
                        <input type="text" id="dict-in-${idx}" placeholder="Type what you hear...">
                        <div id="dict-fb-${idx}" class="feedback"></div>
                        <button class="btn btn-small mt-2" onclick="app.checkDictation(${idx}, '${sent.replace(/'/g, "\\'")}')">Check</button>
                    `;
                    container.appendChild(div);
                });
            },

            checkDictation: function(idx, correct) {
                const input = document.getElementById(`dict-in-${idx}`);
                const fb = document.getElementById(`dict-fb-${idx}`);
                
                // Remove punctuation for easier matching
                const cleanIn = input.value.toLowerCase().replace(/[^a-z ]/g, "").trim();
                const cleanCorr = correct.toLowerCase().replace(/[^a-z ]/g, "").trim();

                if (cleanIn === cleanCorr) {
                    fb.textContent = "Perfect Match!";
                    fb.className = "feedback correct";
                    if (!input.dataset.scored) {
                        this.scores.dictation++;
                        input.dataset.scored = "true";
                        this.updateUI();
                    }
                } else {
                    fb.innerHTML = `Try again.<br><span style="font-weight:normal; font-size:0.9rem; color:#666">Correct: ${correct}</span>`;
                    fb.className = "feedback incorrect";
                }
            },

            // 5. SCRAMBLE LOGIC
            renderScramble: function() {
                const container = document.getElementById('scramble-list');
                scrambleData.forEach((sentence, idx) => {
                    const words = sentence.split(' ');
                    const shuffled = [...words].sort(() => Math.random() - 0.5);
                    
                    const wrapper = document.createElement('div');
                    wrapper.className = 'scramble-wrapper';
                    
                    wrapper.innerHTML = `
                        <p style="margin-bottom:10px; font-weight:bold;">Sentence ${idx+1}</p>
                        <div class="pool-area source-pool" id="src-${idx}"></div>
                        <div class="pool-area dest-pool" id="dest-${idx}"></div>
                        <div id="scram-fb-${idx}" class="feedback"></div>
                        <div style="text-align:right">
                            <button class="btn btn-small" onclick="app.checkScramble(${idx}, '${sentence.replace(/'/g, "\\'")}')">Check Order</button>
                        </div>
                    `;
                    container.appendChild(wrapper);

                    const srcPool = document.getElementById(`src-${idx}`);
                    const destPool = document.getElementById(`dest-${idx}`);

                    shuffled.forEach(word => {
                        const span = document.createElement('span');
                        span.className = 'drag-word';
                        span.textContent = word;
                        span.onclick = function() {
                            if (this.parentElement === srcPool) {
                                destPool.appendChild(this);
                            } else {
                                srcPool.appendChild(this);
                            }
                        };
                        srcPool.appendChild(span);
                    });
                });
            },

            checkScramble: function(idx, correct) {
                const dest = document.getElementById(`dest-${idx}`);
                const fb = document.getElementById(`scram-fb-${idx}`);
                const userSent = Array.from(dest.children).map(c => c.textContent).join(' ');

                if (userSent === correct) {
                    fb.textContent = "Correct! Well done.";
                    fb.className = "feedback correct";
                    if (!dest.dataset.scored) {
                        this.scores.scramble++;
                        dest.dataset.scored = "true";
                        this.updateUI();
                        this.speak(correct);
                    }
                } else {
                    fb.textContent = "Incorrect order.";
                    fb.className = "feedback incorrect";
                }
            },

            updateUI: function() {
                document.getElementById('score-vocab').textContent = this.scores.vocab;
                document.getElementById('score-grammar').textContent = this.scores.grammar;
                document.getElementById('score-dictation').textContent = this.scores.dictation;
                document.getElementById('score-scramble').textContent = this.scores.scramble;
            }
        };

        // Initialize App
        window.onload = function() {
            app.init();
        };

    </script>
</body>
</html>
